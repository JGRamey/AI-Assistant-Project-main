import sqlite3
import time
from src.utils import encrypt_data

def init_audit_log():
    conn = sqlite3.connect('logs/audit_log.db')
    c = conn.cursor()
    c.execute('CREATE TABLE IF NOT EXISTS audit_log (user_id TEXT, action TEXT, data TEXT, timestamp INTEGER)')
    # Sample data
    c.execute('INSERT INTO audit_log VALUES (?, ?, ?, ?)',
              ('user123', 'code_task', '{"task": "generate_rust"}', int(time.time())))
    c.execute('INSERT INTO audit_log VALUES (?, ?, ?, ?)',
              ('user123', 'trade_task', '{"task": "fetch_data"}', int(time.time())))
    conn.commit()
    conn.close()
    print("Audit log initialized with sample data.")

def query_audit_log(user_id):
    conn = sqlite3.connect('logs/audit_log.db')
    c = conn.cursor()
    c.execute('SELECT * FROM audit_log WHERE user_id = ?', (user_id,))
    results = c.fetchall()
    conn.close()
    return [{'user_id': r[0], 'action': r[1], 'data': r[2], 'timestamp': r[3]} for r in results]

if __name__ == '__main__':
    init_audit_log()
    print(query_audit_log('user123'))